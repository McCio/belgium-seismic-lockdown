---
title: "Project Code"
author: "Diletta Olliaro"
date: "5/6/2020"
output: pdf_document
---


```{r}
library(zoo)
library(xts)
tides <- read.csv("dailymax.csv")
days <-seq(from=as.Date("1983-1-01"), length.out = nrow(tides), by="day")
ts.tides <- xts(tides$Level, order.by = days, frequency = 365)
#xts objects have frequency set to daily by default, so we change it
attr(ts.tides, 'frequency') <- 365
```
Once notice the composition is additive (the fluctuations does not seem to grow with the trend)
```{r}
decomposition <- decompose(as.ts(ts.tides), "additive")
plot(decomposition)
```

We now extract the trend using a linear filter with smoothing parameter $p$ equal to 180 (almost half a year):

```{r}
p <- 180
weights <- rep(1/(2*p+1), times=2*p+1)
trend <- filter(ts.tides, sides=2, filter = weights)
```

And they match:
```{r}
plot(trend)
lines(decomposition$trend, col="red")
```

Then we use a filter able also to capture some seasonal effect so we will be able to find the residuals. We are going to choose $f=365$ so to have the moving average from the first day of the year to the last one and then shifted from the second day of the year to the first one of the following year and so, this is because we believe to have an yearly seasonality.

```{r}
f <- 365
weights.s <- c(0.5, rep(1,f-1), 0.5)/f
trend.s <- filter(ts.tides, side=2, filter=weights.s)
residuals <- as.ts(ts.tides)-trend.s
```

and they match (with some error of course) with the ones found with the decompose function.

```{r}
plot(residuals)
lines(decomposition$random, col="red")
```
Finally we want to prove we can retrieve seasonality, in order to do so we can compute the average seasonality starting from the detrended series: to do so we put the time series into a matrix and we transform this matrix so each column contains elements of the same period and finally, we compute the mean of each column. We will check this with the element figure of the object decomposition i.e. the estimated seasonal figure not repeated for all the time series. 

```{r}
detrended <- as.ts(ts.tides)-trend
#t takes the transpose
matrix <- t(matrix(data = detrended, nrow = 365))
seasonality = as.ts(colMeans(matrix, na.rm = T))
```

and they almost match:

```{r}
plot(seasonality)
lines(decomposition$figure, col="red")
```

In fact we are able to reconstruct the original series, with of course some missing value at the beginning and at the end because of the methods applied previously:

```{r}
ts <- residuals+trend+rep(seasonality,36)
plot(as.ts(ts.tides))
lines(ts, col="blue")
```



```{r}
matrix2 <- t(matrix(data = decomposition$random, nrow = 14))
seasonality2 = as.ts(colMeans(matrix2, na.rm = T))
plot(seasonality2)
```





```{r}
g <- residuals-rep(seasonality2, 469)
plot(g)
acf(na.omit(g))
```












